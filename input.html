<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AW Digital Guestbook - Input Tamu Baru">
    <title>Input Tamu | AW Digital Guestbook</title>

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- QRCode.js (browser version) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top glass-navbar">
        <div class="container">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-book-open me-2"></i>AW Digital
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-home me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="input.html">
                            <i class="fas fa-user-plus me-1"></i>Input
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="manage.html">
                            <i class="fas fa-users-cog me-1"></i>Kelola
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="scan.html">
                            <i class="fas fa-qrcode me-1"></i>Scan
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="eventDropdown" role="button"
                            data-bs-toggle="dropdown">
                            <i class="fas fa-calendar-alt me-1"></i><span id="currentEventName">Event</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end glass-modal" id="eventsList">
                            <li>
                                <div class="text-center py-2"><i class="fas fa-spinner fa-spin"></i></div>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero-section" style="min-height: 30vh; padding: 100px 0 40px;">
        <div class="container text-center">
            <div class="hero-content">
                <h1 class="display-5 fw-bold mb-2 animate-fade-in">
                    <i class="fas fa-user-plus me-3"></i>Input Tamu Baru
                </h1>
                <p class="lead mb-0 animate-fade-in-delay">
                    Tambahkan tamu dan generate QR Code otomatis
                </p>
            </div>
        </div>
        <div class="hero-wave">
            <svg viewBox="0 0 1440 120" preserveAspectRatio="none">
                <path d="M0,64 C288,120 576,0 864,64 C1152,128 1344,32 1440,64 L1440,120 L0,120 Z"
                    fill="var(--bg-dark)"></path>
            </svg>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content" style="padding-top: 2rem;">
        <div class="container">
            <div class="row g-4">
                <!-- Form Column -->
                <div class="col-lg-6">
                    <div class="glass-card">
                        <div class="card-header-custom">
                            <h3><i class="fas fa-clipboard-list me-2"></i>Form Input Tamu</h3>
                        </div>

                        <form id="guestForm" novalidate>
                            <div class="mb-3">
                                <label class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"
                                        style="background: var(--bg-glass); border-color: var(--border-color); color: var(--text-muted);">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" class="form-control" id="nama" placeholder="Contoh: Budi Santoso"
                                        required>
                                </div>
                                <div class="invalid-feedback" id="namaError"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"
                                        style="background: var(--bg-glass); border-color: var(--border-color); color: var(--text-muted);">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    <input type="email" class="form-control" id="email"
                                        placeholder="Contoh: budi@email.com" required>
                                </div>
                                <div class="invalid-feedback" id="emailError"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nomor Telepon <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"
                                        style="background: var(--bg-glass); border-color: var(--border-color); color: var(--text-muted);">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    <input type="tel" class="form-control" id="telepon"
                                        placeholder="Contoh: 081234567890" required>
                                </div>
                                <div class="invalid-feedback" id="teleponError"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Nomor Meja (Opsional)</label>
                                <div class="input-group">
                                    <span class="input-group-text"
                                        style="background: var(--bg-glass); border-color: var(--border-color); color: var(--text-muted);">
                                        <i class="fas fa-chair"></i>
                                    </span>
                                    <input type="text" class="form-control" id="tableNumber" placeholder="Contoh: A1">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Pesan/Ucapan <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="pesan" rows="4"
                                    placeholder="Tulis pesan atau ucapan..." required></textarea>
                                <div class="invalid-feedback" id="pesanError"></div>
                                <small class="text-muted"><span id="pesanCount">0</span>/500 karakter</small>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                    <span class="btn-text">
                                        <i class="fas fa-paper-plane me-2"></i>Simpan & Generate QR
                                    </span>
                                    <span class="btn-loader d-none">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Menyimpan...
                                    </span>
                                </button>
                                <button type="reset" class="btn btn-outline-secondary" id="resetBtn">
                                    <i class="fas fa-redo me-2"></i>Reset Form
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- QR Code Column -->
                <div class="col-lg-6">
                    <div class="glass-card" id="qrContainer" style="display: none;">
                        <div class="card-header-custom">
                            <h3><i class="fas fa-qrcode me-2"></i>QR Code Tamu</h3>
                        </div>

                        <div class="text-center">
                            <div class="qr-display mb-4"
                                style="background: white; padding: 2rem; border-radius: 16px; display: inline-block;">
                                <div id="qrCanvas"></div>
                            </div>

                            <div class="guest-info mb-4">
                                <h4 id="guestName" class="mb-2">-</h4>
                                <p class="text-muted mb-1"><i class="fas fa-envelope me-2"></i><span
                                        id="guestEmail">-</span></p>
                                <p class="text-muted mb-1"><i class="fas fa-phone me-2"></i><span
                                        id="guestPhone">-</span></p>
                                <p class="text-muted mb-0" id="guestTableInfo" style="display: none;">
                                    <i class="fas fa-chair me-2"></i>Meja: <span id="guestTable">-</span>
                                </p>
                            </div>

                            <div class="qr-code-string mb-4">
                                <small class="text-muted">Kode QR:</small>
                                <code class="d-block" id="qrCodeString">-</code>
                            </div>

                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-primary" onclick="downloadQR()">
                                    <i class="fas fa-download me-2"></i>Download QR
                                </button>
                                <button class="btn btn-info" onclick="shareToWhatsApp()">
                                    <i class="fab fa-whatsapp me-2"></i>Share
                                </button>
                                <button class="btn btn-outline-secondary" onclick="addAnother()">
                                    <i class="fas fa-plus me-2"></i>Tambah Lagi
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="glass-card" id="instructionsCard">
                        <div class="card-header-custom">
                            <h3><i class="fas fa-info-circle me-2"></i>Petunjuk</h3>
                        </div>
                        <ol class="mb-0" style="color: var(--text-secondary);">
                            <li class="mb-2">Isi form data tamu dengan lengkap</li>
                            <li class="mb-2">Klik "Simpan & Generate QR" untuk menyimpan</li>
                            <li class="mb-2">QR Code akan otomatis ter-generate</li>
                            <li class="mb-2">Download QR atau share via WhatsApp</li>
                            <li class="mb-0">Tamu dapat menggunakan QR untuk check-in</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-code me-2"></i>AW Digital Guestbook &copy; 2024
            </p>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = 'api';
        let currentEventId = null;
        let lastCreatedGuest = null;

        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE}/auth.php?action=check`);
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = 'login.html';
                    return;
                }

                loadEvents();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        // Load user's events
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/events.php`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    renderEventsList(data.data);

                    // Check URL params for event
                    const urlParams = new URLSearchParams(window.location.search);
                    const eventParam = urlParams.get('event');

                    if (eventParam) {
                        currentEventId = parseInt(eventParam);
                        const event = data.data.find(e => e.id === currentEventId);
                        if (event) {
                            document.getElementById('currentEventName').textContent = event.name;
                        }
                    } else {
                        // Use first event as default
                        currentEventId = data.data[0].id;
                        document.getElementById('currentEventName').textContent = data.data[0].name;
                    }
                } else {
                    // No events, redirect to create one
                    showToast('Buat event terlebih dahulu', 'warning');
                    setTimeout(() => {
                        window.location.href = 'events.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // Render events dropdown
        function renderEventsList(events) {
            const list = document.getElementById('eventsList');
            let html = '';

            events.forEach(event => {
                html += `
                    <li>
                        <a class="dropdown-item" href="?event=${event.id}" style="color: var(--text-primary);">
                            <i class="fas fa-calendar-alt me-2"></i>${escapeHtml(event.name)}
                        </a>
                    </li>
                `;
            });

            html += '<li><hr class="dropdown-divider"></li>';
            html += '<li><a class="dropdown-item" href="events.html" style="color: var(--accent-color);"><i class="fas fa-plus me-2"></i>Kelola Events</a></li>';

            list.innerHTML = html;
        }

        // Character counter for pesan
        document.getElementById('pesan').addEventListener('input', function () {
            const count = this.value.length;
            document.getElementById('pesanCount').textContent = count;

            if (count > 500) {
                this.value = this.value.substring(0, 500);
                document.getElementById('pesanCount').textContent = 500;
            }
        });

        // Form submission
        document.getElementById('guestForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentEventId) {
                showToast('Pilih event terlebih dahulu', 'warning');
                return;
            }

            // Get form values
            const formData = {
                event_id: currentEventId,
                nama: document.getElementById('nama').value.trim(),
                email: document.getElementById('email').value.trim(),
                telepon: document.getElementById('telepon').value.trim(),
                pesan: document.getElementById('pesan').value.trim(),
                tableNumber: document.getElementById('tableNumber').value.trim() || null
            };

            // Clear previous errors
            clearErrors();

            // Validate
            if (!validateForm(formData)) return;

            // Show loading
            setLoading(true);

            try {
                const response = await fetch(`${API_BASE}/guests.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    lastCreatedGuest = data.data;
                    showQRCode(data.data);
                    showToast('Tamu berhasil ditambahkan!', 'success');
                } else {
                    if (data.errors) {
                        showErrors(data.errors);
                    } else {
                        showToast(data.message || 'Gagal menyimpan data', 'danger');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Terjadi kesalahan', 'danger');
            } finally {
                setLoading(false);
            }
        });

        // Validate form
        function validateForm(data) {
            let valid = true;
            const errors = {};

            if (!data.nama) {
                errors.nama = 'Nama harus diisi';
                valid = false;
            } else if (data.nama.length < 3) {
                errors.nama = 'Nama minimal 3 karakter';
                valid = false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!data.email) {
                errors.email = 'Email harus diisi';
                valid = false;
            } else if (!emailRegex.test(data.email)) {
                errors.email = 'Format email tidak valid';
                valid = false;
            }

            const phoneRegex = /^[0-9]{10,13}$/;
            const cleanPhone = data.telepon.replace(/\D/g, '');
            if (!data.telepon) {
                errors.telepon = 'Nomor telepon harus diisi';
                valid = false;
            } else if (!phoneRegex.test(cleanPhone)) {
                errors.telepon = 'Nomor telepon harus 10-13 digit';
                valid = false;
            }

            if (!data.pesan) {
                errors.pesan = 'Pesan harus diisi';
                valid = false;
            } else if (data.pesan.length < 10) {
                errors.pesan = 'Pesan minimal 10 karakter';
                valid = false;
            }

            if (!valid) showErrors(errors);
            return valid;
        }

        // Show QR Code
        function showQRCode(guest) {
            document.getElementById('instructionsCard').style.display = 'none';
            document.getElementById('qrContainer').style.display = 'block';

            // Update guest info
            document.getElementById('guestName').textContent = guest.nama;
            document.getElementById('guestEmail').textContent = guest.email;
            document.getElementById('guestPhone').textContent = guest.telepon;
            document.getElementById('qrCodeString').textContent = guest.qrCode;

            if (guest.tableNumber) {
                document.getElementById('guestTableInfo').style.display = 'block';
                document.getElementById('guestTable').textContent = guest.tableNumber;
            } else {
                document.getElementById('guestTableInfo').style.display = 'none';
            }

            // Generate QR Code - clear previous and create new
            const qrCanvas = document.getElementById('qrCanvas');
            qrCanvas.innerHTML = '';
            new QRCode(qrCanvas, {
                text: guest.qrCode,
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Download QR Code
        function downloadQR() {
            if (!lastCreatedGuest) return;

            const qrContainer = document.getElementById('qrCanvas');
            const canvas = qrContainer.querySelector('canvas') || qrContainer.querySelector('img');
            if (!canvas) return;

            const link = document.createElement('a');
            link.download = `QR_${lastCreatedGuest.nama.replace(/\s+/g, '_')}.png`;

            if (canvas.tagName === 'CANVAS') {
                link.href = canvas.toDataURL('image/png');
            } else {
                // For img element
                link.href = canvas.src;
            }
            link.click();
        }

        // Share to WhatsApp
        function shareToWhatsApp() {
            if (!lastCreatedGuest) return;

            const message = `Halo ${lastCreatedGuest.nama}!\n\nBerikut adalah QR Code undangan Anda:\n${lastCreatedGuest.qrCode}\n\nTunjukkan QR Code ini saat datang ke acara.\n\nTerima kasih!`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        // Add another guest
        function addAnother() {
            document.getElementById('guestForm').reset();
            document.getElementById('pesanCount').textContent = '0';
            document.getElementById('qrContainer').style.display = 'none';
            document.getElementById('instructionsCard').style.display = 'block';
            lastCreatedGuest = null;
            document.getElementById('nama').focus();
        }

        // Helper functions
        function showErrors(errors) {
            Object.keys(errors).forEach(field => {
                const input = document.getElementById(field);
                const errorDiv = document.getElementById(field + 'Error');
                if (input) input.classList.add('is-invalid');
                if (errorDiv) errorDiv.textContent = errors[field];
            });
        }

        function clearErrors() {
            ['nama', 'email', 'telepon', 'pesan'].forEach(field => {
                const input = document.getElementById(field);
                const errorDiv = document.getElementById(field + 'Error');
                if (input) input.classList.remove('is-invalid');
                if (errorDiv) errorDiv.textContent = '';
            });
        }

        function setLoading(loading) {
            const btn = document.getElementById('submitBtn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoader = btn.querySelector('.btn-loader');

            btn.disabled = loading;
            btnText.classList.toggle('d-none', loading);
            btnLoader.classList.toggle('d-none', !loading);
        }

        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast show toast-${type}`;
            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'danger' ? 'exclamation-circle text-danger' : 'info-circle text-warning'} me-2"></i>
                    <strong class="me-auto">Notifikasi</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            clearErrors();
            document.getElementById('pesanCount').textContent = '0';
        });

        // Initialize
        checkAuth();
    </script>
</body>

</html>